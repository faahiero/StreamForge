trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Configurações Gerais
  dockerRegistryServiceConnection: 'AcrConnection'
  containerRegistry: 'streamforge.azurecr.io'
  
  # Configurações de Imagem
  apiImageName: 'streamforge-api'
  workerImageName: 'streamforge-worker'
  tag: '$(Build.BuildId)'

stages:
# -----------------------------------------------------------------------------
# Estágio 1: Build & Push (Gera as imagens Docker)
# -----------------------------------------------------------------------------
- stage: BuildAndPush
  displayName: Build and Push Images
  jobs:
  - job: Build
    displayName: Build Docker Images
    steps:
    - task: Docker@2
      displayName: Build API
      inputs:
        command: buildAndPush
        repository: $(apiImageName)
        dockerfile: src/StreamForge.API/Dockerfile
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest

    - task: Docker@2
      displayName: Build Worker
      inputs:
        command: buildAndPush
        repository: $(workerImageName)
        dockerfile: src/StreamForge.Worker/Dockerfile
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)
          latest

# -----------------------------------------------------------------------------
# Estágio 2: Deploy para DEV (Branch: develop)
# -----------------------------------------------------------------------------
- stage: DeployDev
  displayName: Deploy to Development
  dependsOn: BuildAndPush
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/develop'))
  variables:
    - group: StreamForge-Dev
  jobs:
  - job: DeployACA
    displayName: Deploy to Azure Container Apps (Dev)
    steps:
    - task: AzureContainerApps@1
      displayName: Deploy API
      inputs:
        azureSubscription: 'AzureConnection'
        containerAppName: 'streamforge-api-dev'
        resourceGroup: 'rg-streamforge-dev'
        imageToDeploy: '$(containerRegistry)/$(apiImageName):$(tag)'
        environmentVariables: |
          AWS__AccessKey=$(AWS_AccessKey)
          AWS__SecretKey=$(AWS_SecretKey)
          AWS__ServiceURL=$(AWS_ServiceURL)
          AWS__QueueUrl=$(AWS_QueueUrl)
          ConnectionStrings__Redis=$(ConnectionStrings_Redis)

    - task: AzureContainerApps@1
      displayName: Deploy Worker
      inputs:
        azureSubscription: 'AzureConnection'
        containerAppName: 'streamforge-worker-dev'
        resourceGroup: 'rg-streamforge-dev'
        imageToDeploy: '$(containerRegistry)/$(workerImageName):$(tag)'
        environmentVariables: |
          AWS__AccessKey=$(AWS_AccessKey)
          AWS__SecretKey=$(AWS_SecretKey)
          AWS__ServiceURL=$(AWS_ServiceURL)
          AWS__QueueUrl=$(AWS_QueueUrl)
          ConnectionStrings__Redis=$(ConnectionStrings_Redis)

# -----------------------------------------------------------------------------
# Estágio 3: Deploy para PROD (Branch: main)
# -----------------------------------------------------------------------------
- stage: DeployProd
  displayName: Deploy to Production
  dependsOn: BuildAndPush
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  variables:
    - group: StreamForge-Prod
  jobs:
  - job: DeployACA
    displayName: Deploy to Azure Container Apps (Prod)
    steps:
    - task: AzureContainerApps@1
      displayName: Deploy API
      inputs:
        azureSubscription: 'AzureConnection'
        containerAppName: 'streamforge-api-prod'
        resourceGroup: 'rg-streamforge-prod'
        imageToDeploy: '$(containerRegistry)/$(apiImageName):$(tag)'
        environmentVariables: |
          AWS__AccessKey=$(AWS_AccessKey)
          AWS__SecretKey=$(AWS_SecretKey)
          AWS__QueueUrl=$(AWS_QueueUrl)
          ConnectionStrings__Redis=$(ConnectionStrings_Redis)

    - task: AzureContainerApps@1
      displayName: Deploy Worker
      inputs:
        azureSubscription: 'AzureConnection'
        containerAppName: 'streamforge-worker-prod'
        resourceGroup: 'rg-streamforge-prod'
        imageToDeploy: '$(containerRegistry)/$(workerImageName):$(tag)'
        environmentVariables: |
          AWS__AccessKey=$(AWS_AccessKey)
          AWS__SecretKey=$(AWS_SecretKey)
          AWS__QueueUrl=$(AWS_QueueUrl)
          ConnectionStrings__Redis=$(ConnectionStrings_Redis)
